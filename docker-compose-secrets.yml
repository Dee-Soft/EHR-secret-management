version: '3.8'

services:
  # OpenBao Server
  openbao:
    image: openbao/openbao:latest
    container_name: openbao
    restart: unless-stopped
    ports:
      - "8200:8200"      # API port
      - "8201:8201"      # Cluster port (for future HA setup)
    environment:
      - VAULT_ADDR=http://0.0.0.0:8200
      - VAULT_API_ADDR=http://openbao:8200
    cap_add:
      - IPC_LOCK        # Required for memory locking
    volumes:
      - ./openbao/config:/etc/openbao:ro
      - ./openbao/data:/etc/openbao/data
      - ./openbao/logs:/etc/openbao/logs
    command: server -config=/etc/openbao/openbao-config.hcl
    networks:
      - secrets_net
    depends_on:
      mongodb_vault:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "openbao", "status", "-format=json"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # MongoDB for OpenBao Storage
  mongodb_vault:
    image: mongo:6.0
    container_name: mongodb_vault
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: AdminSecurePassword123!  # CHANGE THIS
      MONGO_INITDB_DATABASE: openbao
    volumes:
      - ./mongodb-vault/data:/data/db
      - ./mongodb-vault/init:/docker-entrypoint-initdb.d:ro
    networks:
      - secrets_net
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/openbao --quiet
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

networks:
  secrets_net:
    external: true
    name: secrets_net
